<html ng-app="angularjs">
    <head>
        <title>Angularjs Loading Promise</title>
        <style>
            .content {
                position: relative;
            }
            .busy .busy-message {
                background-color: white;
                position: absolute;
                top: 0px;
                left: 0px;
                right: 0px;
                bottom: 0px;
            }
        </style>
    </head>
    <body class="test">

        <div class="content" ng-controller="ExampleController as exampleController" busy="{promise: exampleController.progressPromise, message: exampleController.progressMessage}">
            Hello
        </div>


        <script src="js/angular-1.5.7.js"></script>
        <script>
          (function () {
              'use strict';

              angular
                  .module('angularjs', [])
                  .directive('busy',['$compile',
                      function($compile){

                          return {
                              restrict: 'A',
                              link: function(scope, element, attrs, fn) {

                                  var templateElement;
                                  var templateScope = scope.$new();

                                  var finished = false;

                                  var busy = scope.$eval(attrs.busy);

                                  //console.log(busy);

                                  busy.promise.then(function () {
                                      finished = true;
                                      //console.log('promises finished');
                                  });

                                  templateScope.$isActive = function() {
                                      var isActive = !finished;
                                      //console.log('isActive', isActive);
                                      return isActive;
                                  };
                                  templateScope.$message = busy.message;

                                  templateElement = $compile("<div class=\"busy\" ng-show=\"$isActive()\"><div class=\"busy-message\" ng-show=\"$message\" >{{$message}}</div></div>")(templateScope);

                                  element.append(templateElement);

                                  scope.$watch(attrs.busy, function (newVal, oldVal, scope) {
                                      //console.log(newVal, oldVal);
                                      templateScope.$message = newVal.message;
                                  }, true);

                              }
                          };
                      }
                  ])
                  .controller('ExampleController', ['$q', '$timeout', function ($q, $timeout) {
                      var controller = this;
                      var deferred = $q.defer();

                      controller.progressMessage = "loading...";
                      controller.progressPromise = deferred.promise;

                      var counter = 0;
                      var tick = function () {
                          $timeout(function () {
                              counter ++;
                              var message = counter + "/10 ...";
                              //console.log('tick', message);
                              controller.progressMessage = message;
                              if (counter === 10) {
                                  deferred.resolve({});
                              } else {
                                  tick();
                              }
                          },1000);
                      };

                      tick();


                  }]);


          })();
        </script>
    </body>
</html>
